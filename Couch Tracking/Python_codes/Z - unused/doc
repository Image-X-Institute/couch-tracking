from docx.shared import Pt
from docx.oxml.ns import qn
from docx.oxml import OxmlElement

def add_code_paragraph(doc, text):
    p = doc.add_paragraph(text)
    font = p.runs[0].font
    font.name = 'Courier New'
    font.size = Pt(10)
    # Set run to be monospaced (Courier New)
    r = p.runs[0]._element
    r.rPr.rFonts.set(qn('w:eastAsia'), 'Courier New')
    # Optional: set shading background color for code block
    shading_elm = OxmlElement('w:shd')
    shading_elm.set(qn('w:val'), 'clear')
    shading_elm.set(qn('w:color'), 'auto')
    shading_elm.set(qn('w:fill'), 'F2F2F2')  # light grey background
    p._p.get_or_add_pPr().append(shading_elm)
    return p

doc = Document()
doc.add_heading('Clock Synchronization Protocol for Raspberry Pi and Windows Laptop', level=1)

doc.add_heading('1. Prepare Raspberry Pi', level=2)
doc.add_paragraph('Step 1.1: Ensure Pi is connected to the internet')
doc.add_paragraph('Connect Pi to Wi-Fi or another network with internet access. Confirm by running:', style='List Bullet')
add_code_paragraph(doc, 'ping -c 3 google.com')

doc.add_paragraph('Step 1.2: Enable and start systemd-timesyncd service')
add_code_paragraph(doc, '''sudo apt update
sudo apt install systemd-timesyncd -y
sudo systemctl enable systemd-timesyncd
sudo systemctl start systemd-timesyncd''')

doc.add_paragraph('Step 1.3: Enable automatic NTP synchronization on Pi')
add_code_paragraph(doc, 'sudo timedatectl set-ntp true')

doc.add_paragraph('Step 1.4: Verify Pi time sync status')
add_code_paragraph(doc, 'timedatectl status')
doc.add_paragraph('Confirm:\n- System clock synchronized: yes\n- NTP service: active')

doc.add_heading('2. Prepare Windows Laptop', level=2)
doc.add_paragraph('Step 2.1: Ensure laptop is connected to the internet and domain network')
doc.add_paragraph('Confirm by pinging a known server:', style='List Bullet')
add_code_paragraph(doc, 'ping time.windows.com')

doc.add_paragraph('Step 2.2: Configure Windows Time service to use public NTP servers')
doc.add_paragraph('Open Command Prompt as Administrator and run:', style='List Bullet')
add_code_paragraph(doc, '''w32tm /config /manualpeerlist:"time.windows.com,0x9" /syncfromflags:manual /reliable:YES /update
net stop w32time
net start w32time
w32tm /resync /nowait''')

doc.add_paragraph('Step 2.3: Verify Windows time sync status')
add_code_paragraph(doc, 'w32tm /query /status')
doc.add_paragraph('Confirm:\n- Leap Indicator is 0 or 1 (not 3)\n- Stratum is 2 or higher\n- Last Successful Sync Time is recent\n- Source is the NTP server (e.g., time.windows.com)')

doc.add_heading('3. Confirm Both Devices Are Synchronized', level=2)
doc.add_paragraph('Step 3.1: Check Pi current time')
add_code_paragraph(doc, 'date +"%Y-%m-%d %H:%M:%S"')

doc.add_paragraph('Step 3.2: Check Laptop current time')
doc.add_paragraph('Open Command Prompt and run:', style='List Bullet')
add_code_paragraph(doc, '''date /T
time /T''')

doc.add_paragraph('Step 3.3: Compare times')
doc.add_paragraph('The clocks should match within 1-2 seconds. For finer precision, check offset using:', style='List Bullet')
add_code_paragraph(doc, 'w32tm /stripchart /computer:time.windows.com /samples:5 /dataonly')
doc.add_paragraph('Offsets should be within a few milliseconds.')

doc.add_heading('4. Optional: Maintain Sync Over Time', level=2)
doc.add_paragraph('Both systems will automatically keep their clocks synchronized via their respective NTP clients. Ensure both remain connected to the internet or local NTP server for ongoing sync.')

doc.add_heading('Summary', level=2)
table = doc.add_table(rows=3, cols=3)
hdr_cells = table.rows[0].cells
hdr_cells[0].text = 'Device'
hdr_cells[1].text = 'Time Sync Client'
hdr_cells[2].text = 'Command to Enable Sync'

row_cells = table.rows[1].cells
row_cells[0].text = 'Raspberry Pi'
row_cells[1].text = 'systemd-timesyncd'
row_cells[2].text = 'sudo timedatectl set-ntp true'

row_cells = table.rows[2].cells
row_cells[0].text = 'Windows Laptop'
row_cells[1].text = 'Windows Time Service'
row_cells[2].text = 'w32tm /config ... + net stop/start'

doc.add_paragraph('\nIf you want, you can automate or script these steps for easy repeat or recovery.')

file_path = "/mnt/data/Clock_Synchronization_Protocol_Pi_Laptop.docx"
doc.save(file_path)
file_path